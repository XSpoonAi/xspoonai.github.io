# x402 Payment APIs

This reference covers the building blocks that SpoonOS exposes for integrating x402 payments programmatically.

## Python services

### `X402PaymentService`

Located in `spoon_ai/payments/x402_service.py`. Responsibilities:

- Load consolidated configuration via `X402Settings.load()`.
- Build `PaymentRequirements` objects (`build_payment_requirements(request: X402PaymentRequest | None)`).
- Generate signed headers (`build_payment_header(requirements, max_value=None)`), routing to local `PRIVATE_KEY` or Turnkey as needed.
- Decode facilitator receipts (`decode_payment_response(header_value)`).
- Verify/settle payments against the facilitator (`verify_payment`, `settle_payment`, `verify_and_settle`).

Key data models:

| Model | Purpose |
| --- | --- |
| `X402PaymentRequest` | Declarative amount/resource/metadata input used to shape `PaymentRequirements`. |
| `X402PaymentOutcome` | Merges `verify` and `settle` results for the FastAPI paywall router. |
| `X402PaymentReceipt` | Parsed view of `X-PAYMENT-RESPONSE` headers including transaction hash, payer, and network. |

### Environment fallbacks

| Variable | Description |
| --- | --- |
| `PRIVATE_KEY` | Default local signer (0x-prefixed hex). |
| `X402_AGENT_PRIVATE_KEY` | Optional override for agents only. |
| `TURNKEY_*` | (`TURNKEY_BASE_URL`, `TURNKEY_API_PUBLIC_KEY`, `TURNKEY_API_PRIVATE_KEY`, `TURNKEY_ORG_ID`, `TURNKEY_SIGN_WITH`, `TURNKEY_ADDRESS`). If `PRIVATE_KEY` is empty but `TURNKEY_SIGN_WITH` exists, the service uses Turnkey for signing. |
| `X402_*` | Mirrors the `.env` entries from the core concepts page (facilitator URL, asset, network, amount, branding). |

## Built-in tools

### `x402_create_payment`

Generates a signed `X-PAYMENT` header.

Parameters:

| Name | Type | Notes |
| --- | --- | --- |
| `resource` | string | URL that the payment authorizes. |
| `amount_usdc` / `amount_atomic` | float / integer | Specify either USD (converted to atomic units) or exact atomic units. |
| `scheme`, `network`, `pay_to` | string | Optional overrides; default to service settings. |
| `timeout_seconds` | integer | Validity window override. |
| `currency`, `memo`, `payer`, `metadata`, `output_schema` | mixed | Enriched metadata baked into `requirements.extra`. |

Return payload:

```json
{
  "header": "<base64 X-PAYMENT>",
  "requirements": { "...": "..." }
}
```

### `x402_paywalled_request`

End-to-end helper that probes a paywalled HTTP endpoint, signs the payment, and retries automatically.

Extra outputs include:

- `paymentHeader` - the `X-PAYMENT` value used for the retry.
- `requirements` - final `PaymentRequirements` after merging paywall + overrides.
- `paymentResponse` - parsed receipt (if the upstream returned `X-PAYMENT-RESPONSE`).

Errors such as `invalid_exact_evm_payload_signature` or misconfigured environment variables are surfaced via `ToolResult.error`.

## CLI commands

Module: `python -m spoon_ai.payments.cli`.

| Command | Description |
| --- | --- |
| `requirements` | Dumps the default `PaymentRequirements` JSON for the current configuration (optionally filtered by `--network`). |
| `sign` | Produces a signed header for a specific `--resource` with optional overrides (`--amount-usdc`, `--memo`, `--currency`, `--metadata`, `--payer`, `--output-schema`). |

All commands respect the same `.env` resolution order (local key first, Turnkey fallback).

## HTTP interfaces

The `spoon_ai.payments.app` module exposes a FastAPI router with two endpoints:

| Endpoint | Method | Description |
| --- | --- | --- |
| `/x402/requirements` | `GET` | Returns current requirements plus metadata for UI discovery. |
| `/x402/invoke/{agent_name}` | `POST` | Accepts `{"prompt": "..."}` payloads. If the request lacks `X-PAYMENT`, the router responds with a 402 body that mirrors facilitator challenges. With a valid header, it verifies, optionally settles, and forwards the prompt to the named agent. On success it includes `X-PAYMENT-RESPONSE` in the response headers. |

## Integration tips

- Reuse `X402PaymentService.decode_payment_response()` anywhere you persist logs or analytics, so you can recover transaction hashes without re-parsing base64.
- Guard outbound payments by passing `max_value` to `build_payment_header` or `x402_create_payment`, which raises if the paywall demands more than you intend to pay.
- When wrapping third-party paywalls, always copy the facilitator-provided `asset`, `pay_to`, and `resource` values into your overrides; mismatches will cause signature rejection.
